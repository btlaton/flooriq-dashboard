<!-- IQ Preview v0.1 | 2025-08-28 | Hero meter + carousel + list -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FloorIQ • IQ Dashboard</title>

  <link rel="stylesheet" href="https://rsms.me/inter/inter.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.47.0/tabler-icons.min.css" />
  <link rel="icon" href="/static/img/logo_hex_f.svg" type="image/svg+xml" />

  <style>
    :root { --tblr-primary: #764ba2; --tblr-link-color: #764ba2; }
    .week-pill { background: #ffffff; color: var(--tblr-primary); border: 1px solid rgba(0,0,0,0.06); border-radius: 9999px; padding: 6px 12px; font-weight: 600; }
    .score-pill { background: #ffffff; color: var(--tblr-primary); border: 1px solid rgba(0,0,0,0.06); border-radius: 9999px; padding: 6px 12px; font-weight: 700; }
    .score-caption { color: #ffffff; opacity: .9; font-size: 0.75rem; margin-top: 4px; text-align: right; }
    .score-amber { color: #b45309 !important; border-color: rgba(245, 158, 11, 0.35) !important; }
    .score-caption.score-amber { color: #f59e0b !important; opacity: 1; }

    .card { border-radius: 8px; }
    .equipment-item { border: 1px solid #dee2e6; border-radius: 6px; margin-bottom: 8px; padding: 8px 10px; background: white; }
    .equipment-name { font-size: 0.98rem; font-weight: 600; color: #212529; white-space: nowrap; }
    .equipment-minutes { font-size: 1.2rem; font-weight: 700; color: var(--tblr-primary); }
    .trend-indicator { font-size: 0.9rem; font-weight: 600; padding: 2px 8px; border-radius: 4px; }
    .trend-up { background: #28a745; color: #fff; }
    .trend-down { background: #dc3545; color: #fff; }
    .trend-stable { background: #6c757d; color: #fff; }
    .section-card { border: 1px solid var(--tblr-primary); }
    .band-amber { background: #f59e0b; color: #fff; }
    .card-right { min-width: 140px; }
    @media (min-width: 576px) { .card-right { min-width: 180px; } }
    @media (max-width: 420px) { .equipment-minutes { font-size: 1.05rem; } }
    /* FloorIQ meter */
    .fiq-hero { display: flex; flex-direction: column; gap: 8px; }
    .fiq-header { display: flex; justify-content: space-between; align-items: flex-end; }
    .fiq-title { font-weight: 600; }
    .fiq-value { font-size: 1.8rem; font-weight: 700; color: var(--tblr-primary); }
    .fiq-meter { position: relative; display: flex; height: 18px; border-radius: 8px; overflow: hidden; border: 1px solid #e5e7eb; }
    .fiq-band { height: 100%; }
    .fiq-poor { background: #ef4444; }
    .fiq-below { background: #f59e0b; }
    .fiq-average { background: #e9d5ff; }
    .fiq-above { background: #86efac; }
    .fiq-exceptional { background: #22c55e; }
    #fiq-pointer { position: absolute; top: -6px; width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 10px solid #111827; }
    .fiq-legend { display: flex; justify-content: space-between; font-size: 0.75rem; color: #6b7280; }
    .fiq-band-label { text-align: right; font-size: 0.85rem; }
    @media (max-width: 420px) {
      .fiq-value { font-size: 1.5rem; }
      .fiq-meter { height: 16px; }
    }
    /* Smooth scroll offset so content doesn't slam under navbar */
    #tab-equipment { scroll-margin-top: 80px; }
  </style>
</head>
<body>
  <!-- Header with week pill -->
  <nav class="navbar" style="background: var(--tblr-primary); box-shadow: 0 1px 2px rgba(0,0,0,0.12)">
    <div class="container-xl d-flex align-items-center justify-content-between text-white">
      <div class="d-flex align-items-center">
        <i class="ti ti-hexagon-letter-f me-2" style="font-size: 1.2rem;"></i>
        <strong>FloorIQ</strong>
        <span class="ms-2" style="opacity: 0.9;">The Atlas Gym</span>
      </div>
      <div class="text-end"><span id="week-label" class="week-pill">{{ week_label }}</span></div>
    </div>
  </nav>

  <div class="container-xl my-3">
    <div class="d-flex justify-content-between align-items-center">
      <ul class="nav nav-pills" id="dashboardTabs">
        <li class="nav-item">
          <button id="overview-tab" class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-overview" type="button"><i class="ti ti-layout-grid me-2"></i> Overview</button>
        </li>
        <li class="nav-item">
          <button id="equipment-tab" class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-equipment" type="button"><i class="ti ti-list-details me-2"></i> Equipment</button>
        </li>
      </ul>
      
    </div>

    <div class="tab-content pt-3" id="tabsContent">
      <!-- Overview -->
      <div class="tab-pane fade show active" id="tab-overview" role="tabpanel">
        <div class="row g-3">
          <div class="col-12">
            <div class="card section-card">
              <div class="card-body">
                <!-- Primary KPI: FloorIQ Score with meter -->
                <div class="fiq-hero">
                  <div class="fiq-header">
                    <div class="fiq-title">FloorIQ Score</div>
                    <div class="fiq-value">{{ gym_iq }}</div>
                  </div>
                  <div class="fiq-meter">
                    <div class="fiq-band fiq-poor" style="width:42.5%"></div>
                    <div class="fiq-band fiq-below" style="width:5%"></div>
                    <div class="fiq-band fiq-average" style="width:7.5%"></div>
                    <div class="fiq-band fiq-above" style="width:10%"></div>
                    <div class="fiq-band fiq-exceptional" style="width:35%"></div>
                    <div id="fiq-pointer"></div>
                  </div>
                  <div class="fiq-legend"><span>Poor</span><span>Below Avg</span><span>Average</span><span>Above Avg</span><span>Exceptional</span></div>
                  <div class="fiq-band-label"><span class="trend-indicator trend-stable" id="flooriq-band">{{ gym_band }}</span></div>
                </div>

    <!-- Carousel: Top 5 / Bottom 5 -->
    <div id="iqCarousel" class="carousel slide mb-2" data-bs-ride="carousel">
      <div class="carousel-indicators">
        <button type="button" data-bs-target="#iqCarousel" data-bs-slide-to="0" class="active" aria-current="true"></button>
        <button type="button" data-bs-target="#iqCarousel" data-bs-slide-to="1"></button>
      </div>
      <div class="carousel-inner">
        <div class="carousel-item active">
          <div class="card section-card">
            <div class="card-header"><h3 class="card-title text-success"><i class="ti ti-trending-up me-2"></i> Top Performers</h3></div>
            <div class="card-body" id="carousel-top"></div>
          </div>
        </div>
        <div class="carousel-item">
          <div class="card section-card">
            <div class="card-header"><h3 class="card-title text-danger"><i class="ti ti-trending-down me-2"></i> Replacement Candidates</h3></div>
            <div class="card-body" id="carousel-bottom"></div>
          </div>
        </div>
      </div>
                  <button class="carousel-control-prev" type="button" data-bs-target="#iqCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                  </button>
                  <button class="carousel-control-next" type="button" data-bs-target="#iqCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Equipment -->
      <div class="tab-pane fade" id="tab-equipment" role="tabpanel">
        <div class="card mb-3 section-card">
          <div class="card-body py-3">
            <div class="row g-3 align-items-center">
              <div class="col-md-4">
                <label class="form-label small text-muted mb-1" for="sort-select">SORT BY</label>
                <select class="form-select form-select-sm" id="sort-select" name="sort-select">
                  <option value="iq-desc">Score ↓</option>
                  <option value="iq-asc">Score ↑</option>
                  <option value="delta-desc">Biggest Increase</option>
                  <option value="delta-asc">Biggest Decrease</option>
                  <option value="name">Equipment Name</option>
                </select>
              </div>
              <div class="col-md-4">
                <div class="form-label small text-muted mb-1" id="category-label">CATEGORY</div>
                <div class="btn-group w-100" role="group" id="category-pills" aria-labelledby="category-label">
                  <input type="radio" class="btn-check" name="category" id="cat-all" value="all" checked>
                  <label class="btn btn-outline-primary btn-sm" for="cat-all">All</label>
                  <input type="radio" class="btn-check" name="category" id="cat-cardio" value="Cardio">
                  <label class="btn btn-outline-primary btn-sm" for="cat-cardio">Cardio</label>
                  <input type="radio" class="btn-check" name="category" id="cat-strength" value="Strength">
                  <label class="btn btn-outline-primary btn-sm" for="cat-strength">Strength</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-label small text-muted mb-1" id="movement-label">MOVEMENT</div>
                <div class="btn-group w-100" role="group" id="movement-pills" aria-labelledby="movement-label">
                  <input type="radio" class="btn-check" name="movement" id="mv-all" value="all" checked>
                  <label class="btn btn-outline-primary btn-sm" for="mv-all">All</label>
                  <input type="radio" class="btn-check" name="movement" id="mv-up" value="up">
                  <label class="btn btn-outline-primary btn-sm" for="mv-up">↑ Up</label>
                  <input type="radio" class="btn-check" name="movement" id="mv-down" value="down">
                  <label class="btn btn-outline-primary btn-sm" for="mv-down">↓ Down</label>
                </div>
              </div>
            </div>
            <div class="row mt-2"><div class="col-12"><small class="text-muted">Showing <span id="filtered-count">—</span> of <span id="total-equipment">—</span> equipment items</small></div></div>
          </div>
        </div>

        <div class="card section-card">
          <div class="card-body">
            <div id="loading" class="text-center py-5">
              <div class="spinner-border text-primary" role="status"></div>
              <p class="mt-3">Loading equipment data...</p>
            </div>
            <div id="equipment-container" style="display:none;"></div>
            <div id="error" class="alert alert-danger" style="display:none;">
              <h5>Error Loading Equipment</h5>
              <p id="error-message"></p>
              <button class="btn btn-outline-danger" onclick="loadEquipment()">Retry</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="mt-4" style="background: var(--tblr-primary); box-shadow: 0 -1px 2px rgba(0,0,0,0.12)">
    <div class="container-xl py-3 d-flex justify-content-center align-items-center text-white" style="opacity: 0.95;">
      <div>© FloorIQ</div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>
  <script>
    let allEquipment = [];
    let isLoading = false;
    const filters = { category: 'all', movement: 'all', sort: 'iq-desc' };

    function buildCard(item) {
      const pts = (item.delta_iq === 0 ? '—' : (item.delta_iq > 0 ? `+${item.delta_iq}` : `${item.delta_iq}`));
      const trend = (item.delta_iq === 0 ? 'stable' : (item.delta_iq > 0 ? 'up' : 'down'));
      return `
        <div class="equipment-item">
          <div class="d-flex justify-content-between align-items-center">
            <div style="flex:1 1 auto; min-width:0;">
              <div class="equipment-name">${item.name}</div>
              <!-- Details hidden for now -->
            </div>
            <div class="text-end card-right">
              <div class="d-flex align-items-center justify-content-end"><span class="equipment-minutes">${item.iq}</span></div>
              <div class="d-flex justify-content-end align-items-center mt-1">
                <span class="trend-indicator trend-${trend}">${pts}</span>
              </div>
            </div>
          </div>
        </div>`;
    }

    async function loadEquipment() {
      if (isLoading) return; isLoading = true;
      const loading = document.getElementById('loading');
      const container = document.getElementById('equipment-container');
      const error = document.getElementById('error');
      loading.style.display = 'block'; container.style.display = 'none'; error.style.display = 'none';
      try {
        const r = await fetch('/api/equipment');
        const j = await r.json();
        if (!j.success) throw new Error(j.error || 'Failed to load equipment');
        allEquipment = j.equipment || [];
        document.getElementById('total-equipment').textContent = j.total_count;
        applyFilters();
      } catch (e) {
        document.getElementById('error-message').textContent = e.message;
        loading.style.display = 'none'; error.style.display = 'block';
      } finally {
        isLoading = false;
      }
    }

    function applyFilters() {
      let list = allEquipment.slice();
      if (filters.category !== 'all') list = list.filter(e => e.category === filters.category);
      if (filters.movement !== 'all') list = list.filter(e => (filters.movement === 'up' ? e.delta_iq > 0 : e.delta_iq < 0));
      list.sort((a,b) => {
        switch (filters.sort) {
          case 'iq-desc': return b.iq - a.iq;
          case 'iq-asc': return a.iq - b.iq;
          case 'delta-desc': return b.delta_iq - a.delta_iq;
          case 'delta-asc': return a.delta_iq - b.delta_iq;
          case 'name': return a.name.localeCompare(b.name);
          default: return 0;
        }
      });
      renderList(list);
    }

    function renderList(list) {
      const container = document.getElementById('equipment-container');
      const loading = document.getElementById('loading');
      if (list.length === 0) {
        container.innerHTML = '<div class="text-center py-4 text-muted">No equipment matches your filters.</div>';
      } else {
        container.innerHTML = list.map(buildCard).join('');
      }
      loading.style.display = 'none'; container.style.display = 'block';
    }

    function wireFilters() {
      document.querySelectorAll('input[name="category"]').forEach(r => r.addEventListener('change', e => { filters.category = e.target.value; applyFilters(); }));
      document.querySelectorAll('input[name="movement"]').forEach(r => r.addEventListener('change', e => { filters.movement = e.target.value; if (e.target.value === 'up') { filters.sort = 'delta-desc'; document.getElementById('sort-select').value = 'delta-desc'; } else if (e.target.value === 'down') { filters.sort = 'delta-asc'; document.getElementById('sort-select').value = 'delta-asc'; } else { filters.sort = 'iq-desc'; document.getElementById('sort-select').value = 'iq-desc'; } applyFilters(); }));
      const sortSelect = document.getElementById('sort-select');
      sortSelect.addEventListener('change', e => { filters.sort = e.target.value; applyFilters(); });
    }

    async function loadSummary() {
      try {
        const r = await fetch('/api/summary');
        const j = await r.json();
        if (!j.success) return;
        const wl = document.getElementById('week-label');
        if (wl) wl.textContent = j.stats.week_label;
        // Populate top/bottom 5 by IQ
        const sorted = allEquipment.slice().sort((a,b)=>b.iq-a.iq);
        const top5 = sorted.slice(0,5).map(buildCard).join('');
        const bot5 = sorted.slice(-5).reverse().map(buildCard).join('');
        const ct = document.getElementById('carousel-top');
        const cb = document.getElementById('carousel-bottom');
        if (ct) ct.innerHTML = top5;
        if (cb) cb.innerHTML = bot5;

        // Color band for hero card
        const band = (j.stats.gym_band || '').toLowerCase();
        const bandEl = document.getElementById('flooriq-band');
        if (bandEl) {
          bandEl.classList.remove('trend-up','trend-stable','band-amber');
          if (band.includes('below')) bandEl.classList.add('band-amber');
          else if (band.includes('above')) bandEl.classList.add('trend-up');
          else bandEl.classList.add('trend-stable');
        }
        // Position meter pointer
        const score = j.stats.gym_iq || 0;
        const meter = document.querySelector('.fiq-meter');
        const ptr = document.getElementById('fiq-pointer');
        if (meter && ptr) {
          const width = meter.clientWidth;
          const x = Math.max(0, Math.min(width, Math.round((score/200) * width)));
          ptr.style.left = `${x - 6}px`; // center triangle
        }
      } catch (e) { console.error(e); }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      wireFilters();
      await loadEquipment();
      await loadSummary();
    });
  </script>
</body>
</html>
